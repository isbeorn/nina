name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: '3.0.0.0'

jobs:
  build:
    name: Build and Prepare Setup on Windows
    runs-on: windows-latest

    steps:
    - name: Validate version input
      run: |
        $version = "${{ github.event.inputs.version }}"
        if ($version -notmatch '^\d+\.\d+\.\d+(\.\d+)?$') {
          Write-Error "Invalid version format: '$version'. Use format like 3.0.0 or 3.0.0.1"
          exit 1
        }

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: 'true'
        submodules: recursive

    - name: Install B2 CLI
      run: pip install --upgrade b2
        
    - name: Authorize with Backblaze B2
      run: b2 account authorize "${{ secrets.B2_KEY_ID }}" "${{ secrets.B2_APP_KEY }}"

    - name: Download Canon and Nikon DLLs from B2
      run: |
        b2 sync "b2://${{ secrets.B2_PRIVATE_BUCKET }}/Canon" "NINA/External/x64/Canon"
        b2 sync "b2://${{ secrets.B2_PRIVATE_BUCKET }}/Nikon" "NINA/External/x64/Nikon"

    - name: Set up MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Set up .NET 8.0 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Install MkDocs and plugins
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material

    - name: Install WiX Toolset 4 CLI and extensions
      run: |
        dotnet tool install --global wix --version 4.0.5
        wix --version
    
    - name: Install Pandoc
      run: choco install pandoc -y

    - name: Restore NuGet packages
      run: dotnet restore NINA.sln
      
    - name: Generate release notes
      run: |
        pandoc RELEASE_NOTES.md -f markdown -t rtf -s -o RELEASE_NOTES.rtf
        pandoc RELEASE_NOTES.md -f markdown -t html -s -o RELEASE_NOTES.html --template md-template.html --metadata title="Nighttime Imaging 'N' Astronomy"

    - name: Build NINA project
      run: dotnet build NINA\NINA.csproj -c Release -r win-x64

    - name: Copy Canon and Nikon DLLs to build output
      shell: cmd
      run: |
        xcopy NINA\External\x64\Canon NINA\bin\Release\net8.0-windows\win-x64\External\x64\Canon /h/i/c/k/e/r/y
        xcopy NINA\External\x64\Nikon NINA\bin\Release\net8.0-windows\win-x64\External\x64\Nikon /h/i/c/k/e/r/y

    - name: Build MkDocs documentation
      run: |
        mkdocs build -f NINA.Docs\mkdocs-nopdf.yml -c

    - name: Copy MkDocs output to setup target dir
      shell: cmd
      run: |
        mkdir NINA\bin\Release\net8.0-windows\win-x64\docs
        xcopy "NINA.Docs\site" "NINA\bin\Release\net8.0-windows\win-x64\docs" /h/i/c/k/e/r/y

    - name: Build WiX Setup Bundle
      run: dotnet msbuild NINA.SetupBundle\NINA.SetupBundle.wixproj /p:Configuration=Release

    - name: Copy .pdb files to setup output folder
      run: |
        $solutionDir = "$(Resolve-Path .)"
        $config = "Release"
        $pdbSource = "$solutionDir\NINA\bin\$config\net8.0-windows\win-x64"
        $pdbTarget = "$solutionDir\NINA.SetupBundle\bin\$config"

        Remove-Item "$solutionDir\RELEASE_NOTES.rtf" -Force -ErrorAction SilentlyContinue

        $pdbFiles = @(
          "NINA.pdb",
          "NINA.Astrometry.pdb",
          "NINA.Core.pdb",
          "NINA.Equipment.pdb",
          "NINA.Image.pdb",
          "NINA.MGEN.pdb",
          "NINA.Platesolving.pdb",
          "NINA.Profile.pdb",
          "NINA.Sequencer.pdb",
          "NINA.WPF.Base.pdb",
          "NINA.CustomControlLibrary.pdb",
          "NINA.Plugin.pdb"
        )

        foreach ($file in $pdbFiles) {
          Write-Host "Copying $file to setup output"
          Copy-Item "$pdbSource\$file" "$pdbTarget\$file" -Force
        }

    - name: Create ZIP files
      run: |
        $outputPath = "NINA.SetupBundle\bin\Release"
        Compress-Archive -Path "$outputPath\*.exe" -DestinationPath "NINASetupBundle_${{ github.event.inputs.version }}.zip"
        Compress-Archive -Path "$outputPath\*.pdb" -DestinationPath "NINAPdb_x64_${{ github.event.inputs.version }}.zip"

    - name: Upload zipped installer
      uses: actions/upload-artifact@v4
      with:
        name: zipped-installer
        path: "NINASetupBundle_${{ github.event.inputs.version }}.zip"
        if-no-files-found: error

    - name: Upload zipped symbols
      uses: actions/upload-artifact@v4
      with:
        name: zipped-symbols
        path: "NINAPdb_x64_${{ github.event.inputs.version }}.zip"
        if-no-files-found: error

    - name: Upload release notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: |
          RELEASE_NOTES.html

  upload:
    name: Upload Setup to Backblaze B2
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: Download zipped installer
      uses: actions/download-artifact@v4
      with:
        name: zipped-installer
        path: ./artifact

    - name: Download zipped symbols
      uses: actions/download-artifact@v4
      with:
        name: zipped-symbols
        path: ./artifact

    - name: Download release notes
      uses: actions/download-artifact@v4
      with:
        name: release-notes
        path: ./artifact

    - name: Install B2 CLI
      run: pip install --upgrade b2

    - name: Authorize with Backblaze B2
      run: b2 authorize-account "${{ secrets.B2_KEY_ID }}" "${{ secrets.B2_APP_KEY }}"

    - name: Generate versioninfo.json
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}"
        $zipPath = "NINASetupBundle_${{ github.event.inputs.version }}.zip"
        $checksum = Get-FileHash -Path $zipPath -Algorithm MD5 | Select-Object -ExpandProperty Hash
        $url = "https://f002.backblazeb2.com/file/${{ secrets.B2_RELEASE_BUCKET }}/Nightlies/$version/$zipPath"
        $changelogUrl = "https://f002.backblazeb2.com/file/${{ secrets.B2_RELEASE_BUCKET }}/Nightlies/$version/RELEASE_NOTES.html"

        $versionInfo = @{
            version       = $version
            checksum      = $checksum
            file          = $url
            changelog     = $changelogUrl
            checksum_x86  = "57778714DD854CD9602DE7D361A348AE"
            file_x86      = "https://f002.backblazeb2.com/file/ninasetup/Releases/2.1.0.9001/NINASetupBundle_2.1.0.9001_x86.zip"
        }

        $json = $versionInfo | ConvertTo-Json -Depth 2
        $json | Set-Content -Path versioninfo.json -Encoding UTF8
    
    - name: Upload ZIP files to B2
      run: |
        Get-ChildItem ./artifact | Where-Object { $_.Extension -in ".zip", ".json", ".html" } | ForEach-Object {
          b2 file upload "${{ secrets.B2_RELEASE_BUCKET }}" $_.FullName "Nightlies/${{ github.event.inputs.version }}/$($_.Name)"
        }